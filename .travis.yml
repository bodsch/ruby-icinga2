# .travis.yml
language: ruby

sudo: required
bundler_args: --retry=3 --jobs=3

rvm:
  - 2.0
  - 2.1
  - 2.2
  - 2.3
  - 2.4
  - 2.5

services:
  - docker

env:
  global:
    - ICINGA2_VERSION=${ICINGA2_VERSION:-2.8.1}
    - ICINGA2_VCS_REF=r3
    - BUILD_DATE=$(date +"%Y-%m-%d")

jobs:
  include:
    - stage: build docker image
      script:
        - gem install bundler
        - gem update bundler
        - |
          docker run \
          --rm \
          --detach \
          --publish=5665:5665 \
          --env ICINGA2_MASTER=icinga2 \
          --env ICINGA2_API_USERS=root:icinga \
          --env DEMO_DATA=true \
          --hostname=icinga2 \
          bodsch/docker-icinga2:2.8.1-master-r3
        - sleep 10s
        - |
          docker run \
          --rm \
          --detach \
          --env ICINGA2_MASTER=icinga2 \
          --env ICINGA2_PARENT=icinga2 \
          --env CERT_SERVICE_BA_USER=admin \
          --env CERT_SERVICE_BA_PASSWORD=admin \
          --env CERT_SERVICE_API_USER=root \
          --env CERT_SERVICE_API_PASSWORD=icinga \
          --env CERT_SERVICE_SERVER=icinga2 \
          --env CERT_SERVICE_PORT=8080 \
          --env CERT_SERVICE_PATH=/ \
          --hostname=icinga2-satellite \
          bodsch/docker-icinga2:2.8.1-satellite-r3
        - sleep 25s
        - docker ps
        - bundle exec rspec spec

fast_finish: true

gemfile:
  - Gemfile
